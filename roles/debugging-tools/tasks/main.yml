---
- name: Get Windows SDK path
  win_reg_stat:
    path: HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows Kits\Installed Roots
    name: KitsRoot10
  register: sdk_info
- debug:
    msg: "{{ 'SDK found at ' + sdk_info.value | quote if sdk_info.exists else 'SDK not found' }}"
- name: Get Debugging Tools path (x86)
  win_stat:
    path: "{{ sdk_info.value }}Debuggers\\x86"
  register: dbgtools_info_x86
  when: sdk_info.exists
- name: Get Debugging Tools path
  win_stat:
    path: "{{ sdk_info.value }}Debuggers\\x64"
  register: dbgtools_info
  when: sdk_info.exists
- debug:
    msg: "{{ 'Debugging Tools found' if dbgtools_info.stat.exists else 'Debugging Tools not found - all tasks will be skipped' }}"
  when: sdk_info.exists
- name: Loading windbg theme
  win_regedit:
    name: Default
    type: binary
    path: HKCU:\SOFTWARE\Microsoft\Windbg\Workspaces
    data: [0x57,0x44,0x57,0x53,0x01,0x00,0x00,0x00,0x33,0x00,0x00,0x00,0x68,0x00,0x5c,0x00,0xf1,0xff,0xff,0xff,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x01,0x00,0x00,0x00,0x00,0x00,0xee,0x03,0x02,0x01,0x31,0x43,0x00,
  0x6f,0x00,0x6e,0x00,0x73,0x00,0x6f,0x00,0x6c,0x00,0x61,0x00,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x00,0x02,0x00,0x10,0x00,0x04,0x00,0x00,
  0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x02,0x00,0x10,0x00,0x04,0x00,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,
  0x00,0x00,0x10,0x00,0x04,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3d,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3c,0x00,0x00,0x00,
  0x10,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x12,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0x02,0x00,0x10,0x00,
  0x04,0x00,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x02,0x00,0x10,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x08,0xff,0x02,0x00,0x10,0x00,0x04,0x00,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x09,0xff,0x02,0x00,0x10,0x00,0x04,0x00,
  0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x44,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,
  0x00,0x03,0x00,0x10,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x01,0x00,0x70,0x02,0x68,0x02,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0xff,
  0xff,0xff,0x0f,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x08,
  0x00,0x00,0x00,0x0b,0x01,0x00,0x00,0xc4,0x02,0x00,0x00,0x9b,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xca,0x00,0x00,0x00,0x84,0x00,0x00,
  0x00,0x86,0x03,0x00,0x00,0x14,0x02,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0d,0x00,0x00,0x00,0x01,
  0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xba,0x00,0x00,0x00,0xc2,0x00,0x00,0x00,0x76,0x03,0x00,0x00,0x04,0x02,0x00,0x00,0x03,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x10,0x00,0x08,0x00,0x02,0x00,0x00,
  0x00,0xc0,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x38,0x00,0x2c,0x00,0x2c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xbc,0x00,0x00,0x00,0x77,0x00,0x00,0x00,0x99,
  0x05,0x00,0x00,0xc5,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x78,0x00,0x6e,0x00,0x07,0x00,0x00,0x00,0x01,0x00,
  0x00,0x00,0x64,0x00,0x00,0x00,0x14,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0xff,0xff,0xff,0x0f,0x04,0x01,0x00,0x00,0x1d,0x04,0x00,
  0x00,0xc7,0x00,0x00,0x00,0xa7,0x05,0x00,0x00,0xa9,0x03,0x00,0x00,0x07,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
  0xca,0x00,0x00,0x00,0x84,0x00,0x00,0x00,0x86,0x03,0x00,0x00,0x14,0x02,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0xff,0xff,0xff,0x0f,0xff,0xff,0xff,0x0f,0xff,0xff,0xff,0x0f,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x80,0x00,0x74,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,
  0x00,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x40,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xcd,0x04,0x00,0x00,0xdf,0x02,0x00,0x00,0x06,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x0b,
  0x01,0x00,0x00,0xc4,0x02,0x00,0x00,0x9b,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x80,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0x0f,0x00,0x00,0x00,0x00,0xcd,0xff,0xff,
  0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x03,0x00,0x10,0x00,0x04,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x45,0x00,0x00,0x00,0x10,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Copy windbg extensions package (x86)
  win_copy:
    src: winext_x86.zip
    dest: "{{ dbgtools_info_x86.stat.path }}\\"
  when: sdk_info.exists and dbgtools_info_x86.stat.exists
- name: Unpack windbg extensions (x86)
  win_unzip:
    delete_archive: yes
    src: "{{ dbgtools_info_x86.stat.path }}\\winext_x86.zip"
    dest: "{{ dbgtools_info_x86.stat.path }}\\winext\\"
  when: sdk_info.exists and dbgtools_info_x86.stat.exists
- name: Copy windbg extensions package (x64)
  win_copy:
    src: winext_x64.zip
    dest: "{{ dbgtools_info.stat.path }}\\"
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Unpack windbg extensions (x64)
  win_unzip:
    delete_archive: yes
    src: "{{ dbgtools_info.stat.path }}\\winext_x64.zip"
    dest: "{{ dbgtools_info.stat.path }}\\winext\\"
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Prepare external symbols folder
  win_file: 
    path: "{{ symbols_path }}\\dbg"
    state: directory
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Prepare private symbols folder
  win_file:
    path: "{{ symbols_path }}\\private"
    state: directory
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Set _NT_SYMBOL_PATH
  win_environment:
    state: present
    name: _NT_SYMBOL_PATH
    level: machine
    value: "{{ symbols_path}}\\private;SRV*{{ symbols_path }}\\dbg*https://msdl.microsoft.com/download/symbols"
  when: sdk_info.exists and dbgtools_info.stat.exists
- name: Setting PATH variable
  win_path:
    state: present
    scope: machine
    elements: "{{ dbgtools_info.stat.path }}"
  when: sdk_info.exists and dbgtools_info.stat.exists
